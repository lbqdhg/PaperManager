<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>äº‘ç«¯æ•°æ®æ‰¹é‡å¯¼å‡º</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { font-family: 'Microsoft YaHei', sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; background-color: #f4f6f9; }
        .box { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; }
        h1 { color: #333; margin-bottom: 20px; }
        button { padding: 12px 25px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; transition: 0.3s; margin: 10px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
        
        #log { margin-top: 20px; text-align: left; background: #2d2d2d; color: #eee; padding: 15px; border-radius: 5px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; display: none; }
        .success { color: #4caf50; }
        .info { color: #64b5f6; }
        .error { color: #ff5252; }

        /* ç™»å½•å±‚ */
        #loginSection { display: block; }
        #exportSection { display: none; }
        input { padding: 10px; width: 80%; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>

    <div class="box">
        <h1>â˜ï¸ äº‘ç«¯æ•°æ®å¯¼å‡ºå¤‡ä»½</h1>
        
        <div id="loginSection">
            <p>ä¸ºäº†å®‰å…¨ï¼Œå¯¼å‡ºæ•°æ®å‰è¯·å…ˆéªŒè¯èº«ä»½ã€‚</p>
            <input type="email" id="email" placeholder="ç®¡ç†å‘˜é‚®ç®±">
            <input type="password" id="password" placeholder="å¯†ç ">
            <br>
            <button class="btn-primary" id="loginBtn">ğŸ” ç™»å½•å¹¶å‡†å¤‡</button>
        </div>

        <div id="exportSection">
            <p id="welcomeMsg">æ¬¢è¿å›æ¥ï¼</p>
            <p style="color: #666; font-size: 14px;">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œç³»ç»Ÿå°†æŠŠäº‘ç«¯æ‰€æœ‰è®°å½•æ‰“åŒ…ä¸º ZIP ä¸‹è½½ã€‚</p>
            <button class="btn-primary" id="exportBtn">ğŸ“¦ å¼€å§‹æ‰“åŒ…ä¸‹è½½ (.zip)</button>
        </div>

        <div id="log"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // âš ï¸âš ï¸âš ï¸ è¯·æ›¿æ¢ä¸ºä½ çš„ Firebase é…ç½® âš ï¸âš ï¸âš ï¸
        const firebaseConfig = {
        apiKey: "AIzaSyDwO7Jc8qiyGU-WCWj0-eUGFqQZK6-O85M",
        authDomain: "mypapertracker-25674.firebaseapp.com",
        projectId: "mypapertracker-25674",
        storageBucket: "mypapertracker-25674.firebasestorage.app",
        messagingSenderId: "438953417934",
        appId: "1:438953417934:web:001355491d955a6f59449f"
        };

        // åˆå§‹åŒ–
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const COLLECTION_NAME = "submissions";

        // DOM å…ƒç´ 
        const loginSection = document.getElementById('loginSection');
        const exportSection = document.getElementById('exportSection');
        const loginBtn = document.getElementById('loginBtn');
        const exportBtn = document.getElementById('exportBtn');
        const logDiv = document.getElementById('log');

        function log(msg, type = 'info') {
            logDiv.style.display = 'block';
            const p = document.createElement('div');
            p.textContent = `> ${msg}`;
            if (type === 'success') p.className = 'success';
            if (type === 'error') p.className = 'error';
            if (type === 'info') p.className = 'info';
            logDiv.prepend(p);
        }

        // --- 1. ç™»å½•é€»è¾‘ ---
        loginBtn.addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) { alert("è¯·è¾“å…¥è´¦å·å¯†ç "); return; }

            loginBtn.textContent = "éªŒè¯ä¸­...";
            loginBtn.disabled = true;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                log("ç™»å½•æˆåŠŸï¼", "success");
                loginSection.style.display = 'none';
                exportSection.style.display = 'block';
                document.getElementById('welcomeMsg').textContent = `ç®¡ç†å‘˜: ${email}`;
            } catch (error) {
                console.error(error);
                log(`ç™»å½•å¤±è´¥: ${error.message}`, "error");
                loginBtn.textContent = "ğŸ” ç™»å½•å¹¶å‡†å¤‡";
                loginBtn.disabled = false;
                alert("ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æˆ–è´¦å·å¯†ç ã€‚");
            }
        });

        // --- 2. å¯¼å‡ºé€»è¾‘ ---
        exportBtn.addEventListener('click', async () => {
            exportBtn.disabled = true;
            exportBtn.textContent = "â³ æ­£åœ¨ä»äº‘ç«¯æ‹‰å–...";
            
            try {
                // åˆå§‹åŒ– ZIP å¯¹è±¡
                const zip = new JSZip();
                let count = 0;

                // ä» Firestore è·å–æ‰€æœ‰æ•°æ®
                const querySnapshot = await getDocs(collection(db, COLLECTION_NAME));
                
                if (querySnapshot.empty) {
                    alert("äº‘ç«¯æ•°æ®åº“æ˜¯ç©ºçš„ï¼");
                    exportBtn.disabled = false;
                    exportBtn.textContent = "ğŸ“¦ å¼€å§‹æ‰“åŒ…ä¸‹è½½ (.zip)";
                    return;
                }

                log(`æ‰¾åˆ° ${querySnapshot.size} æ¡è®°å½•ï¼Œå¼€å§‹å¤„ç†...`, "info");

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    
                    // è¿˜åŸæ–‡ä»¶åé€»è¾‘ï¼šç¼–å·-çŸ­æ ‡é¢˜.json
                    // éœ€è¦å¤„ç†çŸ­æ ‡é¢˜é‡Œå¯èƒ½åŒ…å«çš„éæ³•å­—ç¬¦ï¼ˆè™½ç„¶ä¸€èˆ¬åªæœ‰è‹±æ–‡ï¼‰
                    const safeTitle = (data.shortTitle || "Untitled").replace(/[\s\\/:"*?<>|]+/g, '_');
                    const filename = `${data.number}-${safeTitle}.json`;

                    // å°†æ•°æ®è½¬ä¸ºæ ¼å¼åŒ–çš„ JSON å­—ç¬¦ä¸²
                    const jsonContent = JSON.stringify(data, null, 2);

                    // æ·»åŠ åˆ° ZIP
                    zip.file(filename, jsonContent);
                    count++;
                    log(`å·²æ·»åŠ : ${filename}`, "info");
                });

                log(`æ‰€æœ‰æ–‡ä»¶å¤„ç†å®Œæ¯•ï¼Œæ­£åœ¨å‹ç¼©...`, "info");
                exportBtn.textContent = "ğŸ“¦ æ­£åœ¨å‹ç¼©...";

                // ç”Ÿæˆå¹¶ä¸‹è½½
                const content = await zip.generateAsync({ type: "blob" });
                const dateStr = new Date().toISOString().slice(0,10);
                saveAs(content, `PaperBackup_${dateStr}.zip`);

                log(`âœ… ä¸‹è½½å·²è§¦å‘ï¼åŒ…å« ${count} ä¸ªæ–‡ä»¶ã€‚`, "success");
                exportBtn.textContent = "âœ… å¯¼å‡ºæˆåŠŸ";
                setTimeout(() => {
                    exportBtn.disabled = false;
                    exportBtn.textContent = "ğŸ“¦ å†æ¬¡æ‰“åŒ…";
                }, 3000);

            } catch (error) {
                console.error("å¯¼å‡ºå¤±è´¥:", error);
                log(`âŒ å¯¼å‡ºå‡ºé”™: ${error.message}`, "error");
                exportBtn.disabled = false;
                exportBtn.textContent = "âŒ é‡è¯•";
            }
        });
    </script>
</body>
</html>