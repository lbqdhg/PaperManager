<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ—§æ•°æ®å¯¼å…¥å·¥å…· (æ–‡ä»¶å¤šé€‰ç‰ˆ)</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .box { border: 2px dashed #007bff; padding: 40px; text-align: center; border-radius: 10px; margin-bottom: 20px; background-color: #f8f9fa; }
        #log { background: #333; color: #fff; padding: 15px; border-radius: 5px; height: 300px; overflow-y: auto; font-family: monospace; font-size: 13px; }
        .success { color: #4caf50; }
        .error { color: #ff5252; }
        .warn { color: #ffc107; }
        h1 { color: #333; }
        .highlight { font-weight: bold; color: #007bff; }
    </style>
</head>
<body>
    <h1>ğŸ“‚ æ—§æ•°æ®å¯¼å…¥ (ä¸‡èƒ½ç‰ˆ)</h1>
    <p>è¯¥ç‰ˆæœ¬å…è®¸ä½ ç›´æ¥é€‰ä¸­æ‰€æœ‰æ–‡ä»¶ï¼Œè§£å†³æ‰¾ä¸åˆ°æ–‡ä»¶çš„é—®é¢˜ã€‚</p>
    
    <div class="box">
        <h3>ğŸ‘‡ ç‚¹è¿™é‡Œ</h3>
        <input type="file" id="fileInput" multiple accept=".json,application/json">
        <p style="margin-top: 10px; color: #666; font-size: 14px;">
            (å¼¹å‡ºçª—å£åï¼Œè¯·æŒ‰ <strong>Ctrl + A</strong> å…¨é€‰é‚£ 11 ä¸ªæ–‡ä»¶ï¼Œç„¶åç‚¹â€œæ‰“å¼€â€)
        </p>
    </div>

    <div id="status" class="highlight">ç­‰å¾…é€‰æ‹©æ–‡ä»¶...</div>
    <div id="log"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, setDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // âš ï¸âš ï¸âš ï¸ è¯·å†æ¬¡å¡«å…¥ä½ çš„é…ç½® âš ï¸âš ï¸âš ï¸
        const firebaseConfig = {
        apiKey: "AIzaSyDwO7Jc8qiyGU-WCWj0-eUGFqQZK6-085M",
        authDomain: "mypapertracker-25674.firebaseapp.com",
        projectId: "mypapertracker-25674",
        storageBucket: "mypapertracker-25674.firebasestorage.app",
        messagingSenderId: "438953417934",
        appId: "1:438953417934:web:001355491d955a6f59449f"
    };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const COLLECTION_NAME = "submissions";

        const fileInput = document.getElementById('fileInput');
        const logDiv = document.getElementById('log');
        const statusDiv = document.getElementById('status');

        function log(msg, type = 'info') {
            const p = document.createElement('div');
            p.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            if (type === 'success') p.className = 'success';
            if (type === 'error') p.className = 'error';
            if (type === 'warn') p.className = 'warn';
            logDiv.prepend(p);
        }

        fileInput.addEventListener('change', async (e) => {
            // 1. è·å–æ‰€æœ‰é€‰ä¸­çš„æ–‡ä»¶
            const rawFiles = Array.from(e.target.files);
            log(`ç³»ç»Ÿæ£€æµ‹åˆ°ä½ é€‰ä¸­äº† ${rawFiles.length} ä¸ªæ–‡ä»¶`, 'info');

            // 2. è¿‡æ»¤ï¼šå¿½ç•¥å¤§å°å†™ (è§£å†³ .JSON é—®é¢˜)
            const jsonFiles = rawFiles.filter(f => f.name.toLowerCase().endsWith('.json'));

            if (jsonFiles.length === 0) {
                log(`âŒ æœªæ‰¾åˆ° JSON æ–‡ä»¶ï¼ä½ é€‰ä¸­çš„å¯èƒ½æ˜¯å…¶ä»–æ ¼å¼ï¼Œæˆ–è€…æ–‡ä»¶ååç¼€ä¸æ˜¯ .json`, 'error');
                if (rawFiles.length > 0) {
                    log(`âš ï¸ ä½ é€‰ä¸­çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶æ˜¯: ${rawFiles[0].name}`, 'warn');
                }
                return;
            }

            if (!confirm(`å‡†å¤‡ä¸Šä¼  ${jsonFiles.length} ä¸ªæ–‡ä»¶ï¼Œç¡®å®šå—ï¼Ÿ`)) return;

            statusDiv.textContent = `ğŸš€ æ­£åœ¨ä¸Šä¼ ... (0/${jsonFiles.length})`;
            let successCount = 0;
            let failCount = 0;

            for (let i = 0; i < jsonFiles.length; i++) {
                const file = jsonFiles[i];
                try {
                    // è¯»å–
                    const content = await readFileAsText(file);
                    const data = JSON.parse(content);
                    
                    // ID ç”Ÿæˆé€»è¾‘ï¼šå»æ‰åç¼€
                    // "1-TestPaper.json" -> "1-TestPaper"
                    const docId = file.name.replace(/\.[^/.]+$/, "");

                    // ä¸Šä¼ 
                    await setDoc(doc(db, COLLECTION_NAME, docId), data, { merge: true });

                    log(`âœ… [${i+1}/${jsonFiles.length}] æˆåŠŸ: ${file.name}`, 'success');
                    successCount++;
                } catch (err) {
                    console.error(err);
                    log(`âŒ [${i+1}/${jsonFiles.length}] å¤±è´¥: ${file.name} - ${err.message}`, 'error');
                    failCount++;
                }
                statusDiv.textContent = `ğŸš€ æ­£åœ¨ä¸Šä¼ ... (${i + 1}/${jsonFiles.length})`;
            }

            statusDiv.textContent = `ğŸ‰ å…¨éƒ¨å®Œæˆï¼æˆåŠŸ: ${successCount}, å¤±è´¥: ${failCount}`;
            alert(`å¯¼å…¥ç»“æŸï¼\næˆåŠŸå¯¼å…¥: ${successCount} ä¸ªæ–‡ä»¶ã€‚\n\nç°åœ¨è¯·å»ä¸»é¡µé¢åˆ·æ–°æŸ¥çœ‹æ•°æ®ã€‚`);
        });

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsText(file);
            });
        }
    </script>
</body>
</html>